<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <canvas id="canvas" width="500" height="350"></canvas>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script>
<script>


(function() {
  var canvas = this.__canvas = new fabric.Canvas('canvas');
  fabric.Object.prototype.transparentCorners = false;
  var radius = 200;
  canvas.preserveObjectStacking = true;

  fabric.Image.fromURL('https://axzsource.com/uploads/-/system/user/avatar/17/avatar.png', function(img) {
    var scalar = 1, abort;
    var path = 'M 230 230 A 45 45, 0, 1, 1, 275 275 L 275 230 Z';
    var shell = new fabric.Rect(path, { 
      width: radius,
        height: radius,
        top: 80,
        left: 80,
        fill: 'red',
      originX: 'center',
      originY: 'center',
    });
    var clipPath = new fabric.Rect( {
      absolutePositioned: true,
      originX: 'center',
      originY: 'center',
      scaleX: 2,
      scaleY: 2,
      width: 250, height: 175, left: 180, top: 10, angle: 25, hasControls: false, fill: "yellow"
    });
    
    function animate() {
      abort = fabric.util.animate({
        startValue: 0,
        endValue: 360 * scalar,
        duration: 1000,
        easing: fabric.util.ease.easeInOutSine,
        onChange: function (value) {
          shell.set('angle', value);
          clipPath.set('angle', value);
          img.set('dirty', true);
        },
        onComplete: function () {
          scalar += Math.sign(scalar);
          scalar *= -1;
          animate();
        }
      });
    }

    img.scale(0.5).set({
      left: 100,
      top: 100,
      clipPath: clipPath
    });
    shell.on('moving', ({ e, transform, pointer }) => {
      //  only because they are absolutePositioned
      clipPath.setPositionByOrigin(shell.getCenterPoint(), 'center', 'center');
      img.set('dirty', true);
    });
    shell.on('rotating', () => {
      clipPath.set({ angle: shell.angle });
      img.set('dirty', true);
    });
    shell.on('selected', () => {
      abort();
    });
    shell.on('deselected', () => {
      scalar = 1;
      // animate()
    });
    img.clipPath = clipPath;
    canvas.add(img, shell);
    canvas.setActiveObject(img);
    // animate();
  });


})();
// ============================

    // var canvas = new fabric.Canvas("canvas");
    // canvas.stateful = true;

    // function getCoords(rect) {
    //   console.log(rect);
    //     var x = rect.left;
    //     var y = rect.top;
    //     var angle = (rect.angle * Math.PI) / 180;

    //     var coords = [{ x, y }];
    //     x += rect.width * Math.cos(angle);
    //     y += rect.width * Math.sin(angle);
    //     coords.push({ x, y });

    //     angle += Math.PI / 2;
    //     x += rect.height * Math.cos(angle);
    //     y += rect.height * Math.sin(angle);
    //     coords.push({ x, y });

    //     angle += Math.PI / 2;
    //     x += rect.width * Math.cos(angle);
    //     y += rect.width * Math.sin(angle);
    //     coords.push({ x, y });
    //     return coords;
    // }

    // function inside(p, vs) {
    //     var inside = false;
    //     for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
    //         var xi = vs[i].x, yi = vs[i].y;
    //         var xj = vs[j].x, yj = vs[j].y;
    //         var intersect =
    //             yi > p.y !== yj > p.y && p.x < ((xj - xi) * (p.y - yi)) / (yj - yi) + xi;
    //         if (intersect) inside = !inside;
    //     }
    //     return inside;
    // }
    // // 父对象固定
    // var parent = new fabric.Rect({
    //     width: 150, height: 100, left: 200, top: 50, angle: 5, selectable: false, fill: "red"
    // });
    // var pCoords = getCoords(parent);
    
    // // 子对象可以移动
    // var child = new fabric.Rect({
    //     width: 250, height: 175, left: 180, top: 10, angle: 25, hasControls: false, fill: "rgba(0,0,255,0.9)"
    // });

    // canvas.add(parent);
    // canvas.add(child);

    // canvas.on("object:moving", function (e) {
    //     var cCoords = getCoords(e.target);
    //     var inBounds = true;
    //     cCoords.forEach(c => { if (inside(c, pCoords)) inBounds = false; });
    //     pCoords.forEach(c => { if (!inside(c, cCoords)) inBounds = false; });
    //     if (inBounds) {
    //         e.target.setCoords();
    //         e.target.saveState();
    //         e.target.set("fill", "rgba(0,0,255,0.9)");            
    //     } else {
    //         e.target.set("fill", "black");
    //         e.target.animate({
    //             left: e.target._stateProperties.left,
    //             top: e.target._stateProperties.top
    //           },{
    //             duration: 500,
    //             onChange: canvas.renderAll.bind(canvas),
    //             easing: fabric.util.ease["easeInBounce"],
    //             onComplete: function() {
    //               e.target.set("fill", "rgba(0,0,255,0.9)");
    //             }
    //         });
    //     }
    // });
</script>
</body>
</html>